/*!
 * chartjs-plugin-piechart-outlabels
 * http://chartjs.org/
 * Version: 0.0.8
 *
 * Copyright 2017 Neckster
 * Released under the MIT license
 * https://github.com/Neckster/chartjs-plugin-piechart-outlabels/blob/master/LICENSE
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("chart.js")):"function"==typeof define&&define.amd?define(["chart.js"],e):e(t.Chart)}(this,function(t){"use strict";function e(t,e){var i=t.outlabels,s={};return i===!1?null:(i===!0&&(i={}),r.merge(s,[e,i]))}t=t&&t.hasOwnProperty("default")?t["default"]:t;var i={LABEL_KEY:"$outlabels",backgroundColor:function(t){return t.dataset.backgroundColor},borderColor:function(t){return t.dataset.backgroundColor},lineColor:function(t){return t.dataset.backgroundColor},borderRadius:2,borderWidth:2,lineWidth:2,color:"white",display:!0,font:{family:void 0,size:void 0,style:void 0,weight:null,maxSize:null,minSize:null,resizable:!0},lineHeight:1.2,padding:{top:4,right:4,bottom:4,left:4},textAlign:"center",stretch:40,text:"%l %p"},s={center:function(t,e,i){var s=(t.startAngle+t.endAngle)/2,h=Math.cos(s),n=Math.sin(s),a=t.outerRadius,o=a+i;return{x:t.x+h*o,y:t.y+n*o,d:o,arc:t,anchor:{x:t.x+h*a,y:t.y+n*a},copy:{x:t.x+h*o,y:t.y+n*o}}},moveFromAnchor:function(t,e){var i=t.arc,s=t.d,h=(i.startAngle+i.endAngle)/2,n=Math.cos(h),a=Math.sin(h);return s+=e,{x:i.x+n*s,y:i.y+a*s,d:s,arc:i,anchor:t.anchor,copy:{x:i.x+n*s,y:i.y+a*s}}}},h=t.helpers,n=i.LABEL_KEY,a={OutLabel:function(e,a,o,r,l){var d=t.helpers.options.resolve;if(!d([r.display,!0],l,a))return delete this,null;var c=l.dataset.data[a],f=l.labels[a],u=h.valueOrDefault(r.text,"%v %p");u=u.replace(/%l/gi,f),u=u.replace(/%v/gi,c),u=u.replace(/%p/gi,(100*l.percent).toFixed(1)+"%");var x=u.match(/[^\r\n]+/g);if(!x||!x.length)return null;for(var y=0;y<x.length;++y)x[y]=x[y].trim();this.init=function(t,s){this.encodedText=r.text,this.text=t,this.lines=s,this.label=f,this.value=c,this.ctx=o,this.style={backgroundColor:d([r.backgroundColor,i.backgroundColor,"black"],l,a),borderColor:d([r.borderColor,i.borderColor,"black"],l,a),borderRadius:d([r.borderRadius,0],l,a),borderWidth:d([r.borderWidth,0],l,a),lineWidth:d([r.lineWidth,2],l,a),lineColor:d([r.lineColor,i.lineColor,"black"],l,a),color:d([r.color,"white"],l,a),font:h.parseFont(d([r.font,{resizable:!0}])),padding:h.options.toPadding(d([r.padding,0],l,a)),textAlign:d([r.textAlign,"left"],l,a)},this.stretch=d([r.stretch,40],l,a),this.size=h.textSize(o,this.lines,this.style.font),this.offsetStep=this.size.width/20,this.offset={x:0,y:0},this.predictedOffset=this.offset;var n=-((e._model.startAngle+e._model.endAngle)/2)/Math.PI,u=Math.abs(n-Math.trunc(n));u>.45&&u<.55?this.predictedOffset.x=0:n<=.45&&n>=-.45?this.predictedOffset.x=this.size.width/2:n>=-1.45&&n<=-.55&&(this.predictedOffset.x=-this.size.width/2)},this.init(u,x),this.computeLabelRect=function(){var t=this.textRect.width+2*this.style.borderWidth,e=this.textRect.height+2*this.style.borderWidth,i=this.textRect.x-this.style.padding.left-this.style.borderWidth,s=this.textRect.y-this.style.padding.top-this.style.borderWidth;return t+=this.style.padding.width,e+=this.style.padding.height,{x:i,y:s,width:t,height:e}},this.computeTextRect=function(){return{x:this.center.x-this.size.width/2,y:this.center.y-this.size.height/2,width:this.size.width,height:this.size.height}},this.getPoints=function(){return[{x:this.labelRect.x,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y+this.labelRect.height},{x:this.labelRect.x,y:this.labelRect.y+this.labelRect.height}]},this.containsPoint=function(t,e){return e||(e=5),this.labelRect.x-e<=t.x&&t.x<=this.labelRect.x+this.labelRect.width+e&&this.labelRect.y-e<=t.y&&t.y<=this.labelRect.y+this.labelRect.height+e},this.drawText=function(){var t,e,i,s=this.style.textAlign,h=this.style.font,n=h.lineHeight,a=this.style.color,o=this.lines.length;if(o&&a)for(t=this.textRect.x,e=this.textRect.y+n/2,"center"===s?t+=this.textRect.width/2:"end"!==s&&"right"!==s||(t+=this.textRect.width),this.ctx.font=this.style.font.string,this.ctx.fillStyle=a,this.ctx.textAlign=s,this.ctx.textBaseline="middle",i=0;i<o;++i)this.ctx.fillText(this.lines[i],Math.round(t),Math.round(e),Math.round(this.textRect.width)),e+=n},this.drawLabel=function(){o.beginPath(),h.canvas.roundedRect(this.ctx,Math.round(this.labelRect.x),Math.round(this.labelRect.y),Math.round(this.labelRect.width),Math.round(this.labelRect.height),this.style.borderRadius),this.ctx.closePath(),this.style.backgroundColor&&(this.ctx.fillStyle=this.style.backgroundColor||"black",this.ctx.fill()),this.style.borderColor&&this.style.borderWidth&&(this.ctx.strokeStyle=this.style.borderColor,this.ctx.lineWidth=this.style.borderWidth,this.ctx.lineJoin="miter",this.ctx.stroke())},this.drawLine=function(){this.ctx.save(),this.ctx.strokeStyle=this.style.lineColor,this.ctx.lineWidth=this.style.lineWidth,this.ctx.lineJoin="miter",this.ctx.beginPath(),this.ctx.moveTo(this.center.anchor.x,this.center.anchor.y),this.ctx.lineTo(this.center.copy.x,this.center.copy.y),this.ctx.stroke(),this.ctx.restore()},this.draw=function(){this.drawLabel(),this.drawText()},this.update=function(t,e,i){this.center=s.center(t,"out",this.stretch),this.moveLabelToOffset(),this.center.x+=this.offset.x,this.center.y+=this.offset.y;for(var h=!1;!h;){this.textRect=this.computeTextRect(),this.labelRect=this.computeLabelRect();var a=this.getPoints();h=!0;for(var o=0;o<i;++o){var r=e[o][n];if(r)for(var l=r.getPoints(),d=0;d<a.length;++d){if(r.containsPoint(a[d])){h=!1;break}if(this.containsPoint(l[d])){h=!1;break}}}h||(this.center=s.moveFromAnchor(this.center,1),this.center.x+=this.offset.x,this.center.y+=this.offset.y)}},this.moveLabelToOffset=function(){this.predictedOffset.x<=0&&this.offset.x>this.predictedOffset.x?(this.offset.x-=this.offsetStep,this.offset.x<=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x)):this.predictedOffset.x>=0&&this.offset.x<this.predictedOffset.x&&(this.offset.x+=this.offsetStep,this.offset.x>=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x))}}},o=t.helpers,r=o.merge(o,{toFontString:function(t){return!t||o.isNullOrUndef(t.size)||o.isNullOrUndef(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family},textSize:function(t,e,i){var s,h=[].concat(e),n=h.length,a=t.font,o=0;for(t.font=i.string,s=0;s<n;++s)o=Math.max(t.measureText(h[s]).width,o);return t.font=a,{height:n*i.lineHeight,width:o}},parseFont:function(e){var i=t.defaults.global,s=o.valueOrDefault(e.size,i.defaultFontSize),h={family:o.valueOrDefault(e.family,i.defaultFontFamily),lineHeight:o.options.toLineHeight(e.lineHeight,s),size:s,style:o.valueOrDefault(e.style,i.defaultFontStyle),weight:o.valueOrDefault(e.weight,null),string:""};return h.string=o.toFontString(h),h},isEmptyObj:function(t){for(var e in t)if(e)return!1;return!0}});t.defaults.outlabeledPie=t.defaults.doughnut;var l=t.controllers.doughnut.extend({update:function(e){var i=this,s=i.chart,h=s.chartArea,n=s.options,a=n.elements.arc,o=h.right-h.left-a.borderWidth,r=h.bottom-h.top-a.borderWidth,l=Math.min(o,r),d={x:0,y:0},c=i.getMeta(),f=n.cutoutPercentage,u=n.circumference;if(u<2*Math.PI){var x=n.rotation%(2*Math.PI);x+=2*Math.PI*(x>=Math.PI?-1:x<-Math.PI?1:0);var y=x+u,g={x:Math.cos(x),y:Math.sin(x)},b={x:Math.cos(y),y:Math.sin(y)},p=x<=0&&y>=0||x<=2*Math.PI&&2*Math.PI<=y,m=x<=.5*Math.PI&&.5*Math.PI<=y||x<=2.5*Math.PI&&2.5*Math.PI<=y,R=x<=-Math.PI&&-Math.PI<=y||x<=Math.PI&&Math.PI<=y,v=x<=.5*-Math.PI&&.5*-Math.PI<=y||x<=1.5*Math.PI&&1.5*Math.PI<=y,M=f/100,z={x:R?-1:Math.min(g.x*(g.x<0?1:M),b.x*(b.x<0?1:M)),y:v?-1:Math.min(g.y*(g.y<0?1:M),b.y*(b.y<0?1:M))},w={x:p?1:Math.max(g.x*(g.x>0?1:M),b.x*(b.x>0?1:M)),y:m?1:Math.max(g.y*(g.y>0?1:M),b.y*(b.y>0?1:M))},P={width:.5*(w.x-z.x),height:.5*(w.y-z.y)};l=Math.min(o/P.width,r/P.height),d={x:(w.x+z.x)*-.5,y:(w.y+z.y)*-.5}}s.borderWidth=i.getMaxBorderWidth(c.data),s.outerRadius=Math.max((l-s.borderWidth)/2,0),s.innerRadius=Math.max(f?s.outerRadius/100*f:0,0),s.radiusLength=(s.outerRadius-s.innerRadius)/s.getVisibleDatasetCount(),s.offsetX=d.x*s.outerRadius,s.offsetY=d.y*s.outerRadius,c.total=i.calculateTotal(),i.outerRadius=s.outerRadius-s.radiusLength*i.getRingIndex(i.index),i.innerRadius=Math.max(i.outerRadius-s.radiusLength,0),i.outerRadius*=.5,i.innerRadius*=.5,t.helpers.each(c.data,function(t,s){i.updateElement(t,s,e)})}});t.controllers.outlabeledPie=l,t.defaults.global.plugins.outlabels=i;var d=i.LABEL_KEY;t.plugins.register({id:"outlabels",resize:function(t,e,i){i.font.resizable&&(i.font.size=e.height/100*2.5,i.font.minSize&&i.font.size<i.font.minSize&&(i.font.size=i.font.minSize),i.font.maxSize&&i.font.size>i.font.maxSize&&(i.font.size=i.font.maxSize),i.font.changed=!0)},afterInit:function(t,e){var i=t.canvas.style;e.font.resizable&&(e.font.size=i.height.slice(0,-2)/100*2.5,e.font.minSize&&e.font.size<e.font.minSize&&(e.font.size=e.font.minSize),e.font.maxSize&&e.font.size>e.font.maxSize&&(e.font.size=e.font.maxSize))},afterDatasetUpdate:function(t,i,s){var h,n,o,l,c=t.config.data.labels,f=t.data.datasets[i.index],u=e(f,s),x=u&&u.display,y=i.meta.data||[],g=t.ctx;g.save();for(var b=0;b<y.length;++b)h=y[b],n=h[d],o=f.data[b]/i.meta.total,l=x&&h&&!h.hidden?new a.OutLabel(h,b,g,u,{chart:t,dataIndex:b,dataset:f,labels:c,datasetIndex:i.index,percent:o}):null,l=r.isEmptyObj(l)?null:l,n&&l&&!s.font.changed&&n.label===l.label&&n.encodedText===l.encodedText&&(l.offset=n.offset),h[d]=l;g.restore(),s.font.changed&&(s.font.changed=!1)},afterDatasetDraw:function(t,e){for(var i,s,h,n=e.meta.data||[],a=t.ctx,o=0;o<2*n.length;++o)h=o<n.length?o:o-n.length,i=n[h],s=i[d],s&&(o<n.length?(s.update(i._view,n,o),s.drawLine(a)):s.draw(a))}})});